# 事务的定义

事务是指一组 SQL 语句组成的数据库逻辑处理单元，在这组的 SQL 操作中，要么全部执行成功，要么全部执行失败。

# 事务的四大特性

### 原子性（Atomicity）

一个事务（transaction）中的所有操作，要么全部完成，要么全部不完成，不会结束在中间某个环节。事务在执行过程中发生错误，会被回滚（Rollback）到事务开始前的状态，就像这个事务从来没有执行过一样。

### 一致性（Consistency）

在事务开始之前和事务结束以后，数据库的完整性没有被破坏。这表示写入的资料必须完全符合所有的预设规则，这包含资料的精确度、串联性以及后续数据库可以自发性地完成预定的工作。

### 隔离性（Isolation）

数据库允许多个并发事务同时对其数据进行读写和修改的能力，隔离性可以防止多个事务并发执行时由于交叉执行而导致数据的不一致。事务隔离分为不同级别，包括读未提交（read uncommitted）、读提交（read committed）、可重复读（repeatable read）和串行化（serializable）。

### 持久性（Durability）

事务处理结束后，对数据的修改就是永久的，即便系统故障也不会丢失。

# 事务的隔离级别

### 读未提交（READ UNCOMMITTED）

在这种隔离级别下，一个事务可以读到另一事务修改了但是未提交的数据。会产生脏读、幻读、可重复读等问题。

### 读已提交（READ COMMITTED）

在这种隔离级别下，一个事务可以读到另一个事务已提交的数据。解决了脏读的问，但是仍然会产生幻读，可重复读的问题。

### 可重复读（REPEATABLE READ）

这是 MySQL 默认的隔离级别。在这种隔离级别下，在一个事务 A 中执行同样的 select 语句，返回结果是不变的。那怕此时开启另一个事务 B 对事务 A 查询的表数据进行了修改，并提交，仍然不会影响到事务 A 查询的结果。

### 可串行化（SERIALIZABLE）

串行化是 4 种事务隔离级别中隔离效果最好的，解决了脏读、可重复读、幻读的问题，但是效果最差，它将事务的执行变为顺序执行，与其他三个隔离级别相比，它就相当于单线程，后一个事务的执行必须等待前一个事务结束。

在这种隔离级别下，同时开启（begin）两个事务（A 和 B），可以在两个事务中同时执行 SELECT 语句，但是当其中一个事务 A 执行了 INSERT、UPDATE、DELETE 语句时，需要另一个事务 B 执行 commit 之后才能进行下去；当事务 A 开启事务（begin）并修改（INSERT、UPDATE、DELETE）了表的内容，必须执行完 commit 语句，另一个事务 B 才能使用 SELECT 查询。

# 事务的相关操作

1. 开启事务：`begin;` 或者 `start transaction;`
2. 回滚：`rollback;`
3. 提交事务：`commit;`
4. 开启（禁用）默认提交事务：`SET autocommit = {0 | 1}`
5. 查看当前隔离级别：`select @@transaction_isolation;`
6. 设置隔离级别：`set {session | global } transaction isolation level {read uncommitted | read committed | repeatable read | serializable};`

# 事务并发可能产生的问题

### 脏读（dirty read）

脏读指的是读到了没有提交的事务的数据。比如在事务 A 中，读到事务 B 修改了但是还未 commit 的数据。

### 不可重复读（non-repeatable read）

不可重复读指的是在一个事务中，前后两次使用相同的查询语句，会查到不同的结果。比如事务 A 执行查询语句`select name from user where id = 1`，在事务 B 中执行`update user set name = 'newValue' where id = 1`，事务 A 中先后两次执行查询语句得到的值就不一样。

### 幻读（phantom read）

一个事务先根据某些条件查询出一些记录，之后另一个事务又向表中插入（删除）了符合这些条件的记录，原先的事务再次按照该条件查询时，会查询到另一个事务插入（删除）后的记录。在 MySQL8 版本中，幻读只会在 READ UNCOMMITTED 和 READ COMMITTED 这两种隔离级别产生。而之前的版本则是在 REPEATABLE READ 这种隔离级别也会产生。

# 具体例子

### 创建一个表 use

```
 CREATE TABLE `user` (
  `id` int NOT NULL AUTO_INCREMENT,
  `name` varchar(20) DEFAULT NULL,
   PRIMARY KEY (`id`)
) 
```
