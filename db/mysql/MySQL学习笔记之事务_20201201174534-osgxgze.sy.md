# 事务的定义
{: id="20201201174536-17s3a08"}

事务是指一组sql语句组成的数据库逻辑处理单元，在这组的sql操作中，要么全部执行成功，要么全部执行失败。
{: id="20201201174536-67gv197"}

# 事务的四大特性
{: id="20201201174536-sx33mj5"}

### 原子性（Atomicity）
{: id="20201201174536-x4x3jr1"}

### 一致性（Consistency）
{: id="20201201174536-646e222"}

### 隔离性（Isolation）
{: id="20201201174536-i3gwjsh"}

### 持久性（Durability）
{: id="20201201174536-hqh86qx"}

# 事务并发可能产生的问题
{: id="20201201174536-vtjzlyu"}

### 脏读（dirty read）
{: id="20201201174536-m5yegwe"}

脏读指的是读到了没有提交的事务的数据。比如在事务A中，读到事务B修改了但是还未commit的数据。
{: id="20201201174536-nr7wbxr"}

### 不可重复读（non-repeatable read）
{: id="20201201174536-roqnoz0"}

不可重复读指的是在一个事务中，前后两次使用相同的查询语句，会查到不同的结果。比如事务A执行查询语句`select name from user where id = 1`，在事务B中执行`update user set name = 'newValue' where id = 1`，事务A中先后两次执行查询语句得到的值就不一样。
{: id="20201201174536-yadtkqa"}

### 幻读（phantom read）
{: id="20201201174536-ipk2j91"}

一个事务先根据某些条件查询出一些记录，之后另一个事务又向表中插入（删除）了符合这些条件的记录，原先的事务再次按照该条件查询时，会查询到另一个事务插入（删除）后的记录。在MySQL8版本中，幻读只会在READ UNCOMMITTED和READ COMMITTED这两种隔离级别产生。而之前的版本则是在REPEATABLE READ这种隔离级别也会产生。
{: id="20201201174536-88uti34"}

# 事务的隔离级别
{: id="20201201174536-kdbdk2h"}

### 读未提交（READ UNCOMMITTED）
{: id="20201201174536-nfpelrs"}

在这种隔离级别下，一个事务可以读到另一事务修改了但是未提交的数据。会产生脏读、幻读、可重复读等问题。
{: id="20201201174536-u1vl9hs"}

### 读已提交（READ COMMITTED）
{: id="20201201174536-z3qnolh"}

在这种隔离级别下，一个事务可以读到另一个事务已提交的数据。解决了脏读的问，但是仍然会产生幻读，可重复读的问题。
{: id="20201201174536-31hagc9"}

### 可重复读（REPEATABLE READ）
{: id="20201201174536-2nix2wo"}

这是MySQL默认的隔离级别。在这种隔离级别下，在一个事务A中执行同样的select语句，返回结果是不变的。那怕此时开启另一个事务B对事务A查询的表数据进行了修改，并提交，仍然不会影响到事务A查询的结果。
{: id="20201201174536-6gtyplq"}

### 可串行化（SERIALIZABLE）
{: id="20201201174536-2zqfzsu"}

串行化是4种事务隔离级别中隔离效果最好的，解决了脏读、可重复读、幻读的问题，但是效果最差，它将事务的执行变为顺序执行，与其他三个隔离级别相比，它就相当于单线程，后一个事务的执行必须等待前一个事务结束。
{: id="20201201174536-s5hk5v5"}

在这种隔离级别下，同时开启（begin）两个事务（A和B），可以在两个事务中同时执行SELECT语句，但是当其中一个事务A执行了INSERT、UPDATE、DELETE语句时，需要另一个事务B执行commit之后才能进行下去；当事务A开启事务（begin）并修改（INSERT、UPDATE、DELETE）了表的内容，必须执行完commit语句，另一个事务B才能使用SELECT查询。
{: id="20201201174536-c2x6bcu"}

# 事务的相关操作
{: id="20201201174536-f11z5n4"}

1. {: id="20201201174536-ss3g7q1"}开启事务：`begin;` 或者 `start transaction;`
2. {: id="20201201174536-thj27lo"}回滚：`rollback;`
3. {: id="20201201174536-349ab94"}提交事务：`commit;`
4. {: id="20201201174536-i1ig06n"}开启（禁用）默认提交事务：`SET autocommit = {0 | 1}`
5. {: id="20201201174536-w57qrrf"}查看当前隔离级别：`select @@transaction_isolation;`
6. {: id="20201201174536-zirwg1v"}设置隔离级别：`set {session | global } transaction isolation level {read uncommitted | read committed | repeatable read | serializable};`
{: id="20201201174536-2eics2b"}

# 具体例子
{: id="20201201174536-ntx13ne"}

### 创建一个表use
{: id="20201201174536-xapc7xq"}

```
 CREATE TABLE `user` (
  `id` int NOT NULL AUTO_INCREMENT,
  `name` varchar(20) DEFAULT NULL,
   PRIMARY KEY (`id`)
) 
```
{: id="20201201174536-sa0tt91"}

{: id="20201201174536-wlainxf"}
