本章先概括介绍运输层协议的特点，以及进程之间的通信以及端口等重要概念。然后讲述比较简单的 UDP 协议。其余的篇幅都是讨论较为复杂但非常重要的 TCP 协议[插图]和可靠传输的工作原理，包括停止等待协议和 ARQ 协议。在详细讲述 TCP 报文段的首部格式之后，讨论 TCP 的三个重要问题：滑动窗口、流量控制和拥塞控制机制。最后，介绍 TCP 的连接管理。
{: id="20201208154657-8p0ldyo"}

**运输层**是整个网络体系结构中的关键层次之一。一定要弄清以下一些重要概念：
{: id="20201208154657-3qh96gi"}

1. {: id="20201208154733-f5pa2ay"}运输层为相互通信的应用进程提供逻辑通信。
2. {: id="20201208154755-4yltakr"}端口和套接字的意义。
3. {: id="20201208154803-1fgo7x2"}无连接的 UDP 的特点。
4. {: id="20201208154811-4ub88o9"}面向连接的 TCP 的特点。
5. {: id="20201208154827-dh343zd"}在不可靠的网络上实现可靠传输的工作原理，停止等待协议和 ARQ 协议。
6. {: id="20201208154834-nef4qec"}TCP 的滑动窗口、流量控制、拥塞控制和连接管理。
{: id="20201208154717-ef9qoc7"}

# 5.1 运输层协议概述
{: id="20201208154839-rk04r33"}

### 5.1.1 进程之间的通信
{: id="20201208154858-1rjxl4w"}

**严格地讲，两个主机进行通信就是两个主机中的应用进程互相通信**。IP 协议虽然能把分组送到目的主机，但是这个分组还停留在主机的网络层而没有交付主机中的应用进程。从运输层的角度看，通信的真正端点并不是主机而是主机中的进程。也就是说，端到端的通信是应用进程之间的通信。在一个主机中经常有多个应用进程同时分别和另一个主机中的多个应用进程通信。
{: id="20201208154912-njjckf1"}

![51.png](assets/20201208161559-d3iyuu0-5-1.png)
{: id="20201208161428-h0wlv4z"}


{: id="20201208161615-u36s3q2"}

**从这里可以看出网络层和运输层有明显的区别。网络层是为主机之间提供逻辑通信，而运输层为应用进程之间提供端到端的逻辑通信**。
{: id="20201208161601-vp2uo10"}

根据应用程序的不同需求，运输层需要有两种不同的运输协议，即**面向连接的 TCP** 和 **无连接的 UDP**。
{: id="20201208161624-c1vknv0"}

![52.png](assets/20201208161804-6japjlj-5-2.png)
{: id="20201208161722-f9emws4"}

{: id="20201208161813-9v4l3sr"}

### 5.1.2 运输层的两个主要协议
{: id="20201208161814-y0g4pxp"}

TCP/IP 运输层的两个主要协议都是因特网的正式标准，即：
{: id="20201208161825-qms1ot0"}

1. {: id="20201208162314-9r5t0nc"}用户数据报协议 UDP (User Datagram Protocol)
2. {: id="20201208162322-pbiugo9"}传输控制协议 TCP (Transmission Control Protocol)
{: id="20201208162309-i12nccf"}

这两种协议在协议栈中的位置：
{: id="20201208162359-v68km13"}

![53.png](assets/20201208162349-lxb12fi-5-3.png)
{: id="20201208162329-330ebr0"}

{: id="20201208162421-ikq4wdn"}

按照 OSI 的术语，两个对等运输实体在通信时传送的数据单位叫作**运输协议数据单元 TPDU (Transport Protocol Data Unit)**。但在 TCP/IP 体系中，则根据所使用的协议是 TCP 或 UDP，分别称之为 **TCP 报文段**(segment) 或 **UDP 用户数据报**。
{: id="20201208162422-u6hi7hr"}

**使用 UDP 和 TCP 协议的各种应用和应用层协议**
{: id="20201208162432-ygowq89"}

![b51.png](assets/20201208162631-a6417qd-b5-1.png)
{: id="20201208162621-zoj6gm7"}

### 5.1.3 运输层的端口
{: id="20201208162827-r1qwlus"}

在后面将讲到的 UDP 和 TCP 的首部格式中，我们将会看到（图 5-5 和图 5-14）它们都有源端口和目的端口这两个重要字段。当运输层收到 IP 层交上来的运输层报文时，就能够根据其首部中的目的端口号把数据交付应用层的目的应用进程。
{: id="20201208162839-ynvsdyk"}

{: id="20201208163042-g8rrtrw"}

# 5.2 用户数据报协议 UDP
{: id="20201208163042-bfg20md"}

### 5.2.1 UDP 概述
{: id="20201208163055-p3w25gv"}

用户数据报协议 UDP 只在 IP 的数据报服务之上增加了很少一点的功能，这就是复用和分用的功能以及差错检测的功能。UDP 的主要特点是：
{: id="20201208163118-tryduw1"}

1. {: id="20201208163124-7cdpvmx"}UDP 是**无连接的**，即发送数据之前不需要建立连接（当然，发送数据结束时也没有连接可释放），因此减少了开销和发送数据之前的时延。
2. {: id="20201208163155-wz3ff48"}UDP 使用**尽最大努力交付**，即不保证可靠交付，因此主机不需要维持复杂的连接状态表（这里面有许多参数）。
3. {: id="20201208163206-s7z7mhe"}UDP 是面向报文的。发送方的 UDP 对应用程序交下来的报文，在添加首部后就向下交付 IP 层。UDP 对应用层交下来的报文，既不合并，也不拆分，而是保留这些报文的边界。这就是说，应用层交给 UDP 多长的报文，UDP 就照样发送，即一次发送一个报文，如图 5-4 所示。在接收方的 UDP，对 IP 层交上来的 UDP 用户数据报，在去除首部后就原封不动地交付上层的应用进程。也就是说，UDP 一次交付一个完整的报文。因此，应用程序必须选择合适大小的报文。若报文太长，UDP 把它交给 IP 层后，IP 层在传送时可能要进行分片，这会降低 IP 层的效率。反之，若报文太短，UDP 把它交给 IP 层后，会使 IP 数据报的首部的相对长度太大，这也降低了 IP 层的效率。
   ![54.png](assets/20201208163308-rbemcqs-5-4.png)
4. {: id="20201208163334-cry740l"}UPD **没有拥塞控制**，因此网络出现的拥塞不会使源主机的发送速率降低。这对某些实时应用是很重要的。很多的实时应用（如 IP 电话、实时视频会议等）要求源主机以恒定的速率发送数据，并且允许在网络发生拥塞时丢失一些数据，但却不允许数据有太大的时延。UDP 正好适合这种要求。
5. {: id="20201208163454-bwh18zf"}UDP **支持一对一、一对多、多对一和多对多的交互通信**。
6. {: id="20201208163501-dg1shqk"}UDP 的**首部开销小**，只有 8 个字节，比 TCP 的 20 个字节的首部要短。
{: id="20201208163308-cm6txfv"}

### 5.2.2 UPD 的首部格式
{: id="20201208163355-3721v0h"}

用户数据报 UDP 有两个字段：数据字段和首部字段。首部字段很简单，只有 8 个字节(图 5-5)，由四个字段组成，**每个字段的长度都是两个字节**。各字段意义如下：
{: id="20201208163550-j3yfmpf"}

![55.png](assets/20201208163652-vrwgvv1-5-5.png)
{: id="20201208163647-gvgtbwz"}

{: id="20201208163654-yi2i2ou"}

**（1）源端口**，即源端口号，在需要对方回信时选用。不需要时可用全 0。
{: id="20201208163602-212zi57"}

**（2）目的端口** ，目的端口号。这在终点交付报文时必须要使用到。
{: id="20201208163745-dfprj7u"}

**（3）长度** ，UDP 用户数据报的长度，其最小值是 8（仅有首部）。
{: id="20201208163757-zgk6yii"}

**（4）检验和**，检测 UDP 用户数据报在传输中是否有错。有错就丢弃。
{: id="20201208163803-s5hd8iw"}

{: id="20201208163837-gu2wmui"}

{: id="20201208163810-2gy4awh"}
